events {
    worker_connections 1024;
}

http {
    # Map request method for admin users endpoint
    map $request_method $admin_users_backend {
        GET     "http://projectpal-backend:8001/api/v1/auth/company-users/";
        POST    "http://projectpal-backend:8001/api/v1/auth/admin/create-user/";
        default "http://projectpal-backend:8001/api/v1/auth/company-users/";
    }

    server {
        listen 8090;

        location / {
            proxy_pass http://projectpal-frontend:8083;
            proxy_set_header Host $host;
        }

        # Admin Portal - Tenants/Companies
        location /api/admin/tenants/ {
            proxy_pass http://projectpal-backend:8001/api/v1/auth/companies/;
            proxy_set_header Host $host;
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET,POST,PUT,DELETE,OPTIONS,PATCH" always;
            add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
        }

        # Admin Portal - Users (method-based routing)
        location /api/admin/users/ {
            proxy_pass $admin_users_backend;
            proxy_set_header Host $host;
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET,POST,PUT,DELETE,OPTIONS,PATCH" always;
            add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
        }

        # Admin Portal - General
        location /api/admin/ {
            proxy_pass http://projectpal-backend:8001/api/v1/auth/admin/;
            proxy_set_header Host $host;
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET,POST,PUT,DELETE,OPTIONS,PATCH" always;
            add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
        }

        # Admin Portal - Plans
        location /api/admin/plans/ {
            proxy_pass http://projectpal-backend:8001/api/v1/auth/plans/;
            proxy_set_header Host $host;
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET,POST,PUT,DELETE,OPTIONS,PATCH" always;
            add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
        }

        # Auth routes (without v1)
        location /api/auth/ {
            proxy_pass http://projectpal-backend:8001/api/v1/auth/;
            proxy_set_header Host $host;
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET,POST,PUT,DELETE,OPTIONS,PATCH" always;
            add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
        }

        # Users routes - map /me to /user
        location /api/users/me/ {
            proxy_pass http://projectpal-backend:8001/api/v1/auth/user/;
            proxy_set_header Host $host;
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET,POST,PUT,DELETE,OPTIONS,PATCH" always;
            add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
        }

        # API v1 routes
        location /api/v1/subscriptions/ {
            proxy_pass http://projectpal-backend:8001/api/v1/subscriptions/;
            proxy_set_header Host $host;
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET,POST,PUT,DELETE,OPTIONS,PATCH" always;
            add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
        }

        location /api/v1/team/ {
            proxy_pass http://projectpal-backend:8001/api/v1/team/;
            proxy_set_header Host $host;
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET,POST,PUT,DELETE,OPTIONS,PATCH" always;
            add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
        }

        location /api/v1/programs/ {
            proxy_pass http://projectpal-backend:8001/api/v1/programs/;
            proxy_set_header Host $host;
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET,POST,PUT,DELETE,OPTIONS,PATCH" always;
            add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
        }

        location /api/v1/projects/ {
            proxy_pass http://projectpal-backend:8001/api/v1/projects/;
            proxy_set_header Host $host;
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET,POST,PUT,DELETE,OPTIONS,PATCH" always;
            add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
        }

        location /api/v1/bot/ {
            proxy_pass http://projectpal-backend:8001/api/v1/bot/;
            proxy_set_header Host $host;
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET,POST,PUT,DELETE,OPTIONS,PATCH" always;
            add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
        }

        location /api/v1/auth/ {
            proxy_pass http://projectpal-backend:8001/api/v1/auth/;
            proxy_set_header Host $host;
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET,POST,PUT,DELETE,OPTIONS,PATCH" always;
            add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
        }

        location /api/v1/users/ {
            proxy_pass http://projectpal-backend:8001/api/v1/users/;
            proxy_set_header Host $host;
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET,POST,PUT,DELETE,OPTIONS,PATCH" always;
            add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
        }

        location /api/v1/ {
            proxy_pass http://projectpal-backend:8001/api/v1/;
            proxy_set_header Host $host;
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET,POST,PUT,DELETE,OPTIONS,PATCH" always;
            add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
        }

        # Fallback API routes
        location /api/ {
            proxy_pass http://projectpal-backend:8001/api/;
            proxy_set_header Host $host;
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET,POST,PUT,DELETE,OPTIONS,PATCH" always;
            add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
        }
    }
}