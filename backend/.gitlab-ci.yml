# GitLab CI/CD Pipeline for ProjeXtPal Backend
# Complete test coverage for ALL 14 methodologies!

stages:
  - lint
  - test
  - security
  - build
  - deploy

variables:
  POSTGRES_DB: projextpal_test
  POSTGRES_USER: projextpal
  POSTGRES_PASSWORD: test_password
  POSTGRES_HOST: postgres
  DATABASE_URL: postgresql://projextpal:test_password@postgres:5432/projextpal_test
  DJANGO_SETTINGS_MODULE: core.settings
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

# Cache pip packages for faster builds
cache:
  paths:
    - .cache/pip
    - backend/venv/

# ============================================================================
# LINT STAGE - Code Quality Checks
# ============================================================================

lint:flake8:
  stage: lint
  image: python:3.9
  before_script:
    - cd backend
    - pip install flake8
  script:
    # Stop on critical errors
    - flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=venv,migrations
    # Warning on style issues (don't fail build)
    - flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics --exclude=venv,migrations
  allow_failure: false
  only:
    - branches
    - merge_requests

lint:black:
  stage: lint
  image: python:3.9
  before_script:
    - cd backend
    - pip install black
  script:
    - black --check --diff --exclude="venv|migrations" .
  allow_failure: true
  only:
    - branches
    - merge_requests

lint:isort:
  stage: lint
  image: python:3.9
  before_script:
    - cd backend
    - pip install isort
  script:
    - isort --check-only --diff --skip venv --skip migrations .
  allow_failure: true
  only:
    - branches
    - merge_requests

# ============================================================================
# TEST STAGE - Complete Methodology Coverage
# ============================================================================

test:backend:
  stage: test
  image: python:3.9
  services:
    - postgres:14
  before_script:
    - cd backend
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - python manage.py migrate --noinput
    - python manage.py check
    - echo "ðŸš€ Testing ALL 14 methodologies!"
    - echo "ðŸ“Š Project Methodologies (8): Waterfall, Kanban, Agile, PRINCE2, LSS Green, LSS Black, Hybrid, Program"
    - echo "ðŸŽ¯ Program Methodologies (6): Program, SAFe, MSP, PMI, P2 Programme, Hybrid Programme"
    - |
      pytest \
        --ignore=cross_methodology/ \
        --ignore=workflow/ \
        --ignore=venv/ \
        -v \
        --cov=. \
        --cov-report=xml \
        --cov-report=term \
        --cov-report=html \
        --tb=short \
        --maxfail=5
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: backend/coverage.xml
    paths:
      - backend/htmlcov/
      - backend/coverage.xml
    expire_in: 1 week
    when: always
  only:
    - branches
    - merge_requests
    - main
    - master
    - develop

# Test specific methodology groups (parallel jobs for speed)
test:waterfall-kanban:
  stage: test
  image: python:3.9
  services:
    - postgres:14
  before_script:
    - cd backend
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - python manage.py migrate --noinput
    - pytest waterfall/ kanban/ -v --tb=short
  only:
    - merge_requests
  when: manual

test:agile-prince2:
  stage: test
  image: python:3.9
  services:
    - postgres:14
  before_script:
    - cd backend
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - python manage.py migrate --noinput
    - pytest agile/ prince2/ -v --tb=short
  only:
    - merge_requests
  when: manual

# ============================================================================
# SECURITY STAGE - Vulnerability Scanning
# ============================================================================

security:bandit:
  stage: security
  image: python:3.9
  before_script:
    - cd backend
    - pip install bandit
  script:
    - bandit -r . -f json -o bandit-report.json -ll --exclude=venv,migrations || true
    - bandit -r . -ll --exclude=venv,migrations
  artifacts:
    paths:
      - backend/bandit-report.json
    expire_in: 1 week
  allow_failure: true
  only:
    - branches
    - merge_requests

security:safety:
  stage: security
  image: python:3.9
  before_script:
    - cd backend
    - pip install safety
  script:
    - safety check --json || true
    - safety check
  allow_failure: true
  only:
    - branches
    - merge_requests

# ============================================================================
# BUILD STAGE - Docker Image
# ============================================================================

build:docker:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - cd backend
    - docker build -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_REF_SLUG .
    - docker build -t $CI_REGISTRY_IMAGE/backend:latest .
    - docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_REF_SLUG
    - docker push $CI_REGISTRY_IMAGE/backend:latest
  only:
    - main
    - master
    - develop
    - tags

# ============================================================================
# DEPLOY STAGES
# ============================================================================

deploy:staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $STAGING_SERVER >> ~/.ssh/known_hosts
  script:
    - |
      ssh $DEPLOY_USER@$STAGING_SERVER << 'ENDSSH'
        cd /var/www/projextpal
        git pull origin develop
        docker-compose pull backend
        docker-compose up -d backend
        docker-compose exec -T backend python manage.py migrate --noinput
        docker-compose exec -T backend python manage.py collectstatic --noinput
      ENDSSH
  environment:
    name: staging
    url: https://staging.projextpal.inclufy.com
  only:
    - develop
  when: manual

deploy:production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $PRODUCTION_SERVER >> ~/.ssh/known_hosts
  script:
    - |
      ssh $DEPLOY_USER@$PRODUCTION_SERVER << 'ENDSSH'
        cd /var/www/projextpal
        git pull origin main
        docker-compose pull backend
        docker-compose up -d backend
        docker-compose exec -T backend python manage.py migrate --noinput
        docker-compose exec -T backend python manage.py collectstatic --noinput
      ENDSSH
  environment:
    name: production
    url: https://projextpal.inclufy.com
  only:
    - main
    - master
    - tags
  when: manual

# ============================================================================
# DATABASE MIGRATIONS CHECK
# ============================================================================

check:migrations:
  stage: lint
  image: python:3.9
  services:
    - postgres:14
  before_script:
    - cd backend
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - python manage.py makemigrations --check --dry-run --noinput
  only:
    - merge_requests
