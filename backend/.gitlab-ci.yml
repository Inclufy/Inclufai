# GitLab CI/CD Pipeline for ProjeXtPal Backend
# Complete test coverage for ALL 14 methodologies!

stages:
  - lint
  - test
  - security
  - build
  - deploy

variables:
  POSTGRES_DB: projextpal_test
  POSTGRES_USER: projextpal
  POSTGRES_PASSWORD: test_password
  POSTGRES_HOST: postgres
  DATABASE_URL: postgresql://projextpal:test_password@postgres:5432/projextpal_test
  DJANGO_SETTINGS_MODULE: core.settings
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip
    - backend/venv/

# ============================================================================
# LINT STAGE
# ============================================================================

lint:flake8:
  stage: lint
  image: python:3.9
  before_script:
    - cd backend
    - pip install flake8
  script:
    - flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=venv,migrations
    - flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics --exclude=venv,migrations
  allow_failure: false
  only:
    - branches
    - merge_requests

lint:black:
  stage: lint
  image: python:3.9
  before_script:
    - cd backend
    - pip install black
  script:
    - black --check --diff --exclude="venv|migrations" .
  allow_failure: true
  only:
    - branches
    - merge_requests

# ============================================================================
# TEST STAGE - All tests in tests/ directory
# ============================================================================

test:backend:
  stage: test
  image: python:3.9
  services:
    - postgres:14
  before_script:
    - cd backend
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - python manage.py migrate --noinput
    - python manage.py check
    - echo "ðŸš€ Testing ALL 14 methodologies from tests/ directory!"
    - |
      pytest tests/ \
        -v \
        --cov=. \
        --cov-report=xml \
        --cov-report=term \
        --cov-report=html \
        --tb=short \
        --maxfail=5
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: backend/coverage.xml
    paths:
      - backend/htmlcov/
      - backend/coverage.xml
    expire_in: 1 week
    when: always
  only:
    - branches
    - merge_requests
    - main
    - master
    - develop

# Test by methodology markers
test:kanban:
  stage: test
  image: python:3.9
  services:
    - postgres:14
  before_script:
    - cd backend
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - python manage.py migrate --noinput
    - pytest tests/kanban/ -v --tb=short
  only:
    - merge_requests
  when: manual

test:prince2:
  stage: test
  image: python:3.9
  services:
    - postgres:14
  before_script:
    - cd backend
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - python manage.py migrate --noinput
    - pytest tests/prince2/ -v --tb=short
  only:
    - merge_requests
  when: manual

test:waterfall:
  stage: test
  image: python:3.9
  services:
    - postgres:14
  before_script:
    - cd backend
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - python manage.py migrate --noinput
    - pytest tests/waterfall/ -v --tb=short
  only:
    - merge_requests
  when: manual

# ============================================================================
# SECURITY STAGE
# ============================================================================

security:bandit:
  stage: security
  image: python:3.9
  before_script:
    - cd backend
    - pip install bandit
  script:
    - bandit -r . -f json -o bandit-report.json -ll --exclude=venv,migrations || true
    - bandit -r . -ll --exclude=venv,migrations
  artifacts:
    paths:
      - backend/bandit-report.json
    expire_in: 1 week
  allow_failure: true
  only:
    - branches
    - merge_requests

security:safety:
  stage: security
  image: python:3.9
  before_script:
    - cd backend
    - pip install safety
  script:
    - safety check || true
  allow_failure: true
  only:
    - branches
    - merge_requests

# ============================================================================
# BUILD STAGE
# ============================================================================

build:docker:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - cd backend
    - docker build -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_REF_SLUG .
    - docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_REF_SLUG
  only:
    - main
    - master
    - develop

# ============================================================================
# DEPLOY STAGES
# ============================================================================

deploy:staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $STAGING_SERVER >> ~/.ssh/known_hosts
  script:
    - |
      ssh $DEPLOY_USER@$STAGING_SERVER << 'ENDSSH'
        cd /var/www/projextpal
        git pull origin develop
        docker-compose restart backend
      ENDSSH
  environment:
    name: staging
    url: https://staging.projextpal.inclufy.com
  only:
    - develop
  when: manual

deploy:production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $PRODUCTION_SERVER >> ~/.ssh/known_hosts
  script:
    - |
      ssh $DEPLOY_USER@$PRODUCTION_SERVER << 'ENDSSH'
        cd /var/www/projextpal
        git pull origin main
        docker-compose restart backend
      ENDSSH
  environment:
    name: production
    url: https://projextpal.inclufy.com
  only:
    - main
    - master
  when: manual
