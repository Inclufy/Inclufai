from rest_framework import serializers
from .models import StatusReport, TrainingMaterial , ReportingItem, Meeting

class StatusReportSerializer(serializers.ModelSerializer):
    id = serializers.CharField(read_only=True)  # String ID to match frontend
    
    class Meta:
        model = StatusReport
        fields = ['id', 'project', 'status', 'progress', 'last_updated', 'created_at', 'updated_at']
        read_only_fields = ['created_at', 'updated_at']
    
    def validate_progress(self, value):
        if value < 0 or value > 100:
            raise serializers.ValidationError("Progress must be between 0 and 100!")
        return value
    
    def to_representation(self, instance):
        """Convert the model instance to JSON representation"""
        representation = super().to_representation(instance)
        # Convert the integer ID to string to match frontend expectation
        representation['id'] = str(instance.id)
        return representation
    
    def create(self, validated_data):
        # The ID will be auto-generated by Django as an integer
        # but will be converted to string in to_representation
        return StatusReport.objects.create(**validated_data)

# Training Material Serializer
class TrainingMaterialSerializer(serializers.ModelSerializer):
    id = serializers.CharField(read_only=True)

    class Meta:
        model = TrainingMaterial
        fields = [
            'id',
            'project',
            'name',
            'audience',
            'format',
            'status',
            'created_at',
            'updated_at',
        ]
        read_only_fields = ['created_at', 'updated_at']

    def to_representation(self, instance):
        data = super().to_representation(instance)
        data['id'] = str(instance.id)
        return data
    
# Report Serializer
class ReportingItemSerializer(serializers.ModelSerializer):
    id = serializers.CharField(read_only=True)
    document = serializers.FileField(required=False, allow_null=True)

    class Meta:
        model = ReportingItem
        fields = [
            'id', 'project', 'name', 'frequency', 'type', 'start_date', 'view',
            'document', 'created_at', 'updated_at'
        ]
        read_only_fields = ['created_at', 'updated_at']

    def to_representation(self, instance):
        data = super().to_representation(instance)
        data['id'] = str(instance.id)
        request = self.context.get('request')
        if instance.document and request:
            data['document'] = request.build_absolute_uri(instance.document.url)
        return data
    

# Meeting Serializer
class MeetingSerializer(serializers.ModelSerializer):
    id = serializers.CharField(read_only=True)

    class Meta:
        model = Meeting
        fields = [
            'id', 'project', 'name', 'type', 'frequency',
            'date', 'time', 'location', 'agenda', 'participants',
            'status', 'created_at', 'updated_at'
        ]
        read_only_fields = ['created_at', 'updated_at']

    def to_representation(self, instance):
        data = super().to_representation(instance)
        data['id'] = str(instance.id)
        return data


class MeetingOccurrenceSerializer(serializers.Serializer):
    # Derived “calendar rows”
    id = serializers.CharField()
    name = serializers.CharField()
    type = serializers.CharField()
    frequency = serializers.CharField()
    date = serializers.DateField()   # occurrence date
    time = serializers.TimeField()
    location = serializers.CharField(allow_blank=True)
    agenda = serializers.ListField(child=serializers.CharField())
    participants = serializers.ListField(child=serializers.CharField())
    status = serializers.CharField()

